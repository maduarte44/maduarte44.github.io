<!DOCTYPE html>
<html lang="es-CL">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tareas</title>
<style>
  :root {
    --white: #ffffff;
    --bg: #f8f7f5;
    --border: #e8e5e0;
    --text: #2a2a2a;
    --text-light: #888;
    --text-mid: #555;
    --prio-alta: #ffcccc;
    --prio-alta-label: #8b0000;
    --prio-media: #fff0cc;
    --prio-media-label: #7a5000;
    --prio-baja: #e6f4ea;
    --prio-baja-label: #2d6a3f;
    --accent: #e05a5a;
    --accent-hover: #c94545;
    --green: #4caf6e;
    --blue: #5b9fd4;
    --yellow: #f5c842;
    --red: #e05a5a;
    --shadow: 0 2px 8px rgba(0,0,0,0.08);
    --shadow-hover: 0 4px 16px rgba(0,0,0,0.13);
    --radius: 14px;
    --radius-sm: 8px;
    --font: "Helvetica Neue", Helvetica, Arial, sans-serif;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: var(--font); background: var(--bg); color: var(--text); min-height: 100vh; -webkit-font-smoothing: antialiased; }

  header {
    background: var(--white); border-bottom: 1px solid var(--border);
    padding: 0 20px; display: flex; align-items: center;
    justify-content: space-between; height: 58px;
    position: sticky; top: 0; z-index: 100;
  }
  .logo { font-size: 20px; font-weight: 700; letter-spacing: -0.5px; }
  .logo span { color: var(--accent); }
  .header-actions { display: flex; gap: 8px; }
  .btn-icon {
    background: none; border: 1.5px solid var(--border);
    border-radius: var(--radius-sm); padding: 6px 12px;
    font-family: var(--font); font-size: 13px; color: var(--text-mid);
    cursor: pointer; transition: all 0.15s; display: flex; align-items: center; gap: 6px;
  }
  .btn-icon:hover { border-color: var(--accent); color: var(--accent); }

  .tabs-wrap {
    background: var(--white); border-bottom: 1px solid var(--border);
    padding: 0 20px; overflow-x: auto; -webkit-overflow-scrolling: touch;
  }
  .tabs { display: flex; min-width: max-content; }
  .tab {
    padding: 14px 18px 12px; font-family: var(--font); font-size: 13px;
    font-weight: 500; color: var(--text-light); background: none; border: none;
    border-bottom: 3px solid transparent; cursor: pointer; transition: all 0.15s; white-space: nowrap;
  }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-badge {
    display: inline-block; background: var(--bg); color: var(--text-mid);
    font-size: 11px; font-weight: 700; border-radius: 20px;
    padding: 1px 7px; margin-left: 5px;
  }
  .tab.active .tab-badge { background: #ffeaea; color: var(--accent); }

  main { padding: 24px 20px 100px; max-width: 680px; margin: 0 auto; }
  .view-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
  .view-title { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
  .view-subtitle { font-size: 13px; color: var(--text-light); margin-top: 2px; }
  .filter-select {
    font-family: var(--font); font-size: 12px; border: 1.5px solid var(--border);
    border-radius: 20px; padding: 5px 12px; background: var(--white);
    color: var(--text-mid); cursor: pointer; outline: none;
  }
  .filter-select:focus { border-color: var(--accent); }

  .move-mode-hint {
    background: #fff3cd; border: 1px solid #ffe08a; border-radius: var(--radius-sm);
    padding: 8px 14px; font-size: 13px; color: #7a5200; margin-bottom: 14px; display: none;
  }
  .move-mode-hint.visible { display: block; }

  .empty-state { text-align: center; padding: 60px 20px; color: var(--text-light); }
  .empty-icon { font-size: 48px; margin-bottom: 12px; }
  .empty-title { font-size: 17px; font-weight: 600; color: var(--text-mid); margin-bottom: 6px; }
  .empty-sub { font-size: 14px; }
  .today-hint {
    background: #fff3cd; border-radius: var(--radius);
    padding: 16px 20px; font-size: 14px; color: #7a5200; line-height: 1.5; margin-bottom: 20px;
  }

  .card-wrap { position: relative; transition: transform 0.18s, opacity 0.18s; }
  .card-wrap.moving-source { opacity: 0.4; transform: scale(0.97); }
  .drop-zone {
    height: 6px; border-radius: 3px; background: transparent;
    margin: 3px 0; transition: all 0.15s; cursor: pointer;
  }
  .drop-zone.highlight { height: 28px; background: rgba(224,90,90,0.12); border: 2px dashed var(--accent); border-radius: var(--radius-sm); }

  .task-card {
    background: var(--white); border-radius: var(--radius);
    border: 1.5px solid var(--border); box-shadow: var(--shadow);
    padding: 16px 16px 14px; margin-bottom: 10px; position: relative;
    transition: box-shadow 0.18s, border-color 0.18s;
  }
  .task-card:hover { box-shadow: var(--shadow-hover); }
  .task-card.completada { opacity: 0.55; }
  .task-card.move-selected { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(224,90,90,0.18), var(--shadow-hover); }
  .task-card::before {
    content: ''; position: absolute; left: 0; top: 12px; bottom: 12px;
    width: 4px; border-radius: 0 2px 2px 0;
    background: var(--stripe-color, #ddd);
  }

  .card-top { display: flex; align-items: flex-start; gap: 10px; padding-left: 12px; }
  .card-check {
    flex-shrink: 0; width: 20px; height: 20px; border-radius: 50%;
    border: 2px solid var(--border); margin-top: 1px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; background: none;
  }
  .card-check:hover { border-color: var(--green); }
  .task-card.completada .card-check { background: var(--green); border-color: var(--green); }
  .card-check-icon { display: none; font-size: 11px; color: white; }
  .task-card.completada .card-check-icon { display: block; }
  .card-main { flex: 1; min-width: 0; }
  .card-title { font-size: 15px; font-weight: 600; line-height: 1.35; margin-bottom: 4px; word-break: break-word; }
  .task-card.completada .card-title { text-decoration: line-through; color: var(--text-light); }
  .card-desc { font-size: 13px; color: var(--text-mid); line-height: 1.4; margin-bottom: 8px; word-break: break-word; }

  .card-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; padding-left: 12px; }
  .tag { font-size: 11px; font-weight: 600; padding: 2px 9px; border-radius: 20px; letter-spacing: 0.3px; text-transform: uppercase; }
  .tag-prio-alta  { background: var(--prio-alta); color: var(--prio-alta-label); }
  .tag-prio-media { background: var(--prio-media); color: var(--prio-media-label); }
  .tag-prio-baja  { background: var(--prio-baja); color: var(--prio-baja-label); }
  .tag-deadline { background: #fce4ec; color: #8e1a4a; }
  .tag-deadline.vencida { background: var(--prio-alta); color: var(--prio-alta-label); }
  .tag-tipo { background: #e8eaf6; color: #3949ab; }

  .card-progress { padding-left: 12px; margin-bottom: 10px; }
  .progress-row { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; }
  .progress-bar-bg { flex: 1; height: 6px; background: var(--bg); border-radius: 3px; overflow: hidden; }
  .progress-bar-fill { height: 100%; border-radius: 3px; transition: width 0.4s; }
  .p100{background:var(--green)} .phigh{background:#5b9fd4} .pmid{background:var(--yellow)} .plow{background:#e0dbd5}
  .progress-label { font-size: 12px; font-weight: 700; color: var(--text-mid); min-width: 32px; text-align: right; }
  .hours-info { font-size: 11px; color: var(--text-light); }

  .card-footer { display: flex; align-items: center; justify-content: space-between; padding-left: 12px; margin-top: 4px; }
  .card-meta { font-size: 11px; color: var(--text-light); }
  .card-actions { display: flex; gap: 4px; }
  .card-btn {
    background: none; border: 1px solid var(--border); border-radius: 6px;
    padding: 4px 10px; font-family: var(--font); font-size: 12px;
    color: var(--text-mid); cursor: pointer; transition: all 0.13s;
  }
  .card-btn:hover { border-color: var(--accent); color: var(--accent); }
  .card-btn.btn-move.selected { background: var(--accent); color: white; border-color: var(--accent); }
  .card-btn.btn-hoy-remove { color: var(--red); border-color: #ffcccc; }
  .card-btn.btn-hoy-remove:hover { background: #fff0f0; }

  .fab {
    position: fixed; bottom: 28px; right: 24px; width: 54px; height: 54px;
    background: var(--accent); color: white; border: none; border-radius: 50%;
    font-size: 26px; cursor: pointer; box-shadow: 0 4px 16px rgba(224,90,90,0.4);
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s; z-index: 99;
  }
  .fab:hover { background: var(--accent-hover); transform: scale(1.07); }

  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 200;
    display: flex; align-items: flex-end; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal {
    background: var(--white); border-radius: var(--radius) var(--radius) 0 0;
    width: 100%; max-width: 680px; max-height: 92vh; overflow-y: auto;
    padding: 24px 24px 32px; transform: translateY(40px);
    transition: transform 0.25s cubic-bezier(0.4,0,0.2,1);
  }
  .modal-overlay.open .modal { transform: translateY(0); }
  .modal-title {
    font-size: 18px; font-weight: 700; margin-bottom: 20px;
    display: flex; align-items: center; justify-content: space-between;
  }
  .modal-close { background: none; border: none; font-size: 22px; color: var(--text-light); cursor: pointer; padding: 2px 6px; }
  .modal-close:hover { color: var(--accent); }

  .form-row { margin-bottom: 16px; }
  .form-row label { display: block; font-size: 12px; font-weight: 600; color: var(--text-mid); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
  .form-row input[type=text],
  .form-row input[type=number],
  .form-row input[type=datetime-local],
  .form-row textarea,
  .form-row select {
    width: 100%; font-family: var(--font); font-size: 14px;
    border: 1.5px solid var(--border); border-radius: var(--radius-sm);
    padding: 10px 12px; color: var(--text); background: var(--white); outline: none; transition: border-color 0.15s;
  }
  .form-row input:focus,.form-row textarea:focus,.form-row select:focus { border-color: var(--accent); }
  .form-row textarea { resize: vertical; min-height: 80px; }
  .form-cols { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .form-check-row { display: flex; align-items: center; gap: 10px; font-size: 14px; color: var(--text-mid); }
  .form-check-row input[type=checkbox] { width: 18px; height: 18px; cursor: pointer; }
  .range-with-label { display: flex; align-items: center; gap: 12px; }
  input[type=range] { flex:1; -webkit-appearance:none; height:6px; border-radius:3px; background:var(--bg); outline:none; }
  input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:18px; height:18px; border-radius:50%; background:var(--accent); cursor:pointer; border:2px solid white; box-shadow:0 1px 4px rgba(0,0,0,0.18); }
  .range-val { font-size:14px; font-weight:700; min-width:38px; text-align:right; }

  .timelog-list { margin-top:8px; border:1.5px solid var(--border); border-radius:var(--radius-sm); overflow:hidden; }
  .timelog-entry { padding:8px 12px; display:flex; align-items:center; gap:10px; font-size:13px; border-bottom:1px solid var(--border); }
  .timelog-entry:last-child { border-bottom:none; }
  .timelog-date { color:var(--text-light); font-size:12px; min-width:100px; }
  .timelog-hours { font-weight:700; min-width:56px; color:var(--blue); }
  .timelog-nota { color:var(--text-mid); flex:1; }
  .timelog-del { background:none; border:none; color:var(--text-light); cursor:pointer; font-size:16px; }
  .timelog-del:hover { color:var(--red); }
  .timelog-add { display:grid; grid-template-columns:90px 1fr auto; gap:8px; margin-top:10px; }
  .timelog-add input { font-family:var(--font); font-size:13px; border:1.5px solid var(--border); border-radius:var(--radius-sm); padding:7px 10px; outline:none; }
  .timelog-add input:focus { border-color:var(--blue); }
  .btn-add-log { background:var(--blue); color:white; border:none; border-radius:var(--radius-sm); padding:7px 14px; font-family:var(--font); font-size:13px; cursor:pointer; }
  .btn-add-log:hover { background:#4a8fc4; }

  .modal-footer { display:flex; gap:10px; margin-top:24px; justify-content:flex-end; }
  .btn-secondary { font-family:var(--font); font-size:14px; font-weight:500; padding:10px 20px; border:1.5px solid var(--border); border-radius:var(--radius-sm); background:var(--white); color:var(--text-mid); cursor:pointer; transition:all 0.13s; }
  .btn-secondary:hover { border-color:var(--text); color:var(--text); }
  .btn-primary { font-family:var(--font); font-size:14px; font-weight:600; padding:10px 24px; background:var(--accent); color:white; border:none; border-radius:var(--radius-sm); cursor:pointer; }
  .btn-primary:hover { background:var(--accent-hover); }
  .btn-danger { font-family:var(--font); font-size:14px; padding:10px 18px; background:none; border:1.5px solid #ffcccc; color:var(--red); border-radius:var(--radius-sm); cursor:pointer; margin-right:auto; }
  .btn-danger:hover { background:#fff0f0; }

  .gist-status { font-size:13px; padding:10px 14px; border-radius:var(--radius-sm); margin-top:12px; }
  .gist-status.ok { background:#e6f4ea; color:#2d6a4f; }
  .gist-status.err { background:#fce4ec; color:#8e1a4a; }
  .gist-status.info { background:#fff3cd; color:#7a5200; }

  /* ‚îÄ‚îÄ‚îÄ √ÅMBITOS MANAGER ‚îÄ‚îÄ‚îÄ */
  .ambito-list { display:flex; flex-direction:column; gap:8px; margin-bottom:16px; }
  .ambito-row {
    display:flex; align-items:center; gap:10px;
    background:var(--bg); border-radius:var(--radius-sm);
    padding:10px 14px; border:1.5px solid var(--border);
  }
  .ambito-swatch { width:26px; height:26px; border-radius:6px; flex-shrink:0; border:1.5px solid rgba(0,0,0,0.12); }
  .ambito-row-emoji { font-size:17px; flex-shrink:0; }
  .ambito-row-name { flex:1; font-size:14px; font-weight:500; }
  .ambito-row-count { font-size:12px; color:var(--text-light); min-width:52px; text-align:right; }
  .btn-ambito-del { background:none; border:1px solid #ffcccc; color:var(--red); border-radius:6px; padding:4px 10px; font-size:12px; font-family:var(--font); cursor:pointer; }
  .btn-ambito-del:hover { background:#fff0f0; }
  .btn-ambito-del:disabled { opacity:0.35; cursor:not-allowed; border-color:var(--border); color:var(--text-light); }

  .new-ambito-form { display:grid; grid-template-columns:46px 1fr 46px auto; gap:8px; align-items:center; margin-top:4px; }
  .new-ambito-form input[type=text] { font-family:var(--font); font-size:14px; border:1.5px solid var(--border); border-radius:var(--radius-sm); padding:9px 12px; outline:none; }
  .new-ambito-form input[type=text]:focus { border-color:var(--accent); }
  .new-ambito-form input[type=color] { width:46px; height:40px; border:1.5px solid var(--border); border-radius:var(--radius-sm); cursor:pointer; padding:2px; }
  .new-ambito-form input.emoji-input { text-align:center; font-size:18px; padding:9px 4px; }
  .btn-add-ambito { background:var(--green); color:white; border:none; border-radius:var(--radius-sm); padding:9px 16px; font-family:var(--font); font-size:13px; font-weight:600; cursor:pointer; white-space:nowrap; }
  .btn-add-ambito:hover { background:#3d9e5e; }
  .ambito-form-hint { font-size:12px; color:var(--text-light); margin-top:10px; }

  ::-webkit-scrollbar { width:6px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

  @media (max-width: 480px) {
    .form-cols { grid-template-columns:1fr; }
    .modal { padding:20px 16px 28px; }
    main { padding:16px 12px 100px; }
    .new-ambito-form { grid-template-columns:40px 1fr 40px auto; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">ta<span>reas</span></div>
  <div class="header-actions">
    <button class="btn-icon" onclick="openAmbitosModal()">‚öô √Åmbitos</button>
    <button class="btn-icon" onclick="openGistModal()">‚áÖ Gist</button>
    <button class="btn-icon" onclick="exportJSON()">‚Üì Export</button>
  </div>
</header>

<div class="tabs-wrap">
  <div class="tabs" id="tabsBar"></div>
</div>

<main>
  <div class="view-header">
    <div>
      <div class="view-title" id="viewTitle">Hoy</div>
      <div class="view-subtitle" id="viewSubtitle"></div>
    </div>
    <select class="filter-select" id="sortSelect" onchange="renderCards()">
      <option value="orden">Orden manual</option>
      <option value="prioridad">Prioridad</option>
      <option value="deadline">Deadline</option>
      <option value="avance">Avance</option>
      <option value="ambito">√Åmbito</option>
    </select>
  </div>
  <div class="move-mode-hint" id="moveModeHint">
    ‚ú¶ Modo mover activo ‚Äî haz clic en otra tarjeta para moverla ah√≠, o en la misma para cancelar.
  </div>
  <div id="cardsContainer"></div>
</main>

<button class="fab" onclick="openTaskModal()">+</button>

<!-- TASK MODAL -->
<div class="modal-overlay" id="taskModal">
  <div class="modal">
    <div class="modal-title">
      <span id="modalTitleText">Nueva tarea</span>
      <button class="modal-close" onclick="closeTaskModal()">√ó</button>
    </div>
    <div class="form-row">
      <label>T√≠tulo *</label>
      <input type="text" id="fTitulo" placeholder="¬øQu√© hay que hacer?">
    </div>
    <div class="form-row">
      <label>Descripci√≥n / Notas</label>
      <textarea id="fDesc" placeholder="Contexto, subtareas, links..."></textarea>
    </div>
    <div class="form-cols">
      <div class="form-row">
        <label>√Åmbito</label>
        <select id="fAmbito"></select>
      </div>
      <div class="form-row">
        <label>Tipo de acci√≥n</label>
        <select id="fTipo">
          <option value="hacer">‚ñ∂ Hacer</option>
          <option value="esperar">‚è∏ Esperar</option>
          <option value="delegar">‚Üó Delegar</option>
          <option value="revisar">üëÅ Revisar</option>
        </select>
      </div>
    </div>
    <div class="form-cols">
      <div class="form-row">
        <label>Prioridad</label>
        <select id="fPrioridad">
          <option value="alta">üî¥ Alta</option>
          <option value="media">üü° Media</option>
          <option value="baja">üü¢ Baja</option>
        </select>
      </div>
      <div class="form-row">
        <label>Tiempo estimado (hrs)</label>
        <input type="number" id="fTiempoEst" min="0" step="0.5" placeholder="Ej: 2.5">
      </div>
    </div>
    <div class="form-row">
      <label>Deadline</label>
      <input type="datetime-local" id="fDeadline">
    </div>
    <div class="form-row">
      <label>% de avance</label>
      <div class="range-with-label">
        <input type="range" id="fAvance" min="0" max="100" value="0"
          oninput="document.getElementById('fAvanceVal').textContent=this.value+'%'">
        <span class="range-val" id="fAvanceVal">0%</span>
      </div>
    </div>
    <div class="form-row">
      <label>Registro de horas trabajadas</label>
      <div id="timelogList" class="timelog-list" style="display:none"></div>
      <div class="timelog-add">
        <input type="number" id="tlHoras" min="0.25" step="0.25" placeholder="Horas">
        <input type="text" id="tlNota" placeholder="Nota (opcional)">
        <button class="btn-add-log" onclick="addTimeLog()">+ Agregar</button>
      </div>
    </div>
    <div class="form-row">
      <div class="form-check-row">
        <input type="checkbox" id="fEnHoy">
        <label for="fEnHoy" style="text-transform:none;letter-spacing:0;font-size:14px;font-weight:400;">Agregar a la lista de hoy</label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-danger" id="btnDelete" onclick="deleteTask()" style="display:none">Eliminar</button>
      <button class="btn-secondary" onclick="closeTaskModal()">Cancelar</button>
      <button class="btn-primary" onclick="saveTask()">Guardar</button>
    </div>
  </div>
</div>

<!-- √ÅMBITOS MODAL -->
<div class="modal-overlay" id="ambitosModal">
  <div class="modal">
    <div class="modal-title">
      <span>Gestionar √°mbitos</span>
      <button class="modal-close" onclick="closeAmbitosModal()">√ó</button>
    </div>
    <div id="ambitosList" class="ambito-list"></div>
    <div style="font-size:12px;font-weight:600;color:var(--text-mid);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;">Nuevo √°mbito</div>
    <div class="new-ambito-form">
      <input type="text" class="emoji-input" id="newAmbitoEmoji" placeholder="üìå" maxlength="2" title="Emoji (opcional)">
      <input type="text" id="newAmbitoNombre" placeholder="Nombre del √°mbito">
      <input type="color" id="newAmbitoColor" value="#9dc8f0" title="Color de acento">
      <button class="btn-add-ambito" onclick="addAmbito()">+ Crear</button>
    </div>
    <p class="ambito-form-hint">El color que eliges se usa como franja lateral en las tarjetas. No se puede eliminar un √°mbito que tenga tareas asignadas.</p>
    <div class="modal-footer">
      <button class="btn-primary" onclick="closeAmbitosModal()">Listo</button>
    </div>
  </div>
</div>

<!-- GIST MODAL -->
<div class="modal-overlay" id="gistModal">
  <div class="modal">
    <div class="modal-title">
      <span>Sincronizaci√≥n con GitHub Gist</span>
      <button class="modal-close" onclick="closeGistModal()">√ó</button>
    </div>
    <div class="form-row">
      <label>Personal Access Token (scope: gist)</label>
      <input type="text" id="gToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
    </div>
    <div class="form-row">
      <label>Gist ID (vac√≠o = crear nuevo)</label>
      <input type="text" id="gGistId" placeholder="Ej: a1b2c3d4e5f6...">
    </div>
    <div id="gistStatus"></div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeGistModal()">Cerrar</button>
      <button class="btn-primary" onclick="gistLoad()" style="background:var(--blue)">‚Üì Cargar desde Gist</button>
      <button class="btn-primary" onclick="gistSave()">‚Üë Guardar en Gist</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ √ÅMBITOS DEFAULT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEFAULT_AMBITOS = [
  { id:'casa',          nombre:'Casa',          emoji:'üè†', bg:'#d4edda', stripe:'#a8d5b5', label:'#2d6a4f' },
  { id:'personal',      nombre:'Personal',      emoji:'üë§', bg:'#cce5ff', stripe:'#9dc8f0', label:'#1a5276' },
  { id:'julieta',       nombre:'Julieta',       emoji:'üíõ', bg:'#fce4ec', stripe:'#f4b8ce', label:'#8e1a4a' },
  { id:'investigacion', nombre:'Investigaci√≥n', emoji:'üî¨', bg:'#fff3cd', stripe:'#ffe08a', label:'#7a5200' },
  { id:'proyectos',     nombre:'Proyectos',     emoji:'üöÄ', bg:'#ffe5d0', stripe:'#ffbf9b', label:'#8b3a00' },
];

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let tasks = [];
let ambitos = [];
let currentTab = 'hoy';
let editingId = null;
let moveSourceId = null;
let tempTimeLogs = [];

const PRIO_ORDER = { alta:0, media:1, baja:2 };

function load() {
  try { tasks = JSON.parse(localStorage.getItem('tareas_v2') || '[]'); } catch(e) { tasks = []; }
  try {
    const a = JSON.parse(localStorage.getItem('tareas_ambitos_v1'));
    ambitos = (Array.isArray(a) && a.length) ? a : JSON.parse(JSON.stringify(DEFAULT_AMBITOS));
  } catch(e) { ambitos = JSON.parse(JSON.stringify(DEFAULT_AMBITOS)); }
}
function save() {
  localStorage.setItem('tareas_v2', JSON.stringify(tasks));
  localStorage.setItem('tareas_ambitos_v1', JSON.stringify(ambitos));
}
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,7); }
function getAmbito(id) { return ambitos.find(a=>a.id===id) || { nombre:id, emoji:'üìå', stripe:'#ccc', bg:'#f0f0f0', label:'#555' }; }

// ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTabs() {
  const fixed = [{ id:'hoy', label:'Hoy' }, { id:'todas', label:'Todas' }];
  const tabs = [...fixed, ...ambitos.map(a=>({ id:a.id, label:a.emoji+' '+a.nombre }))];
  if (!tabs.find(t=>t.id===currentTab)) currentTab = 'hoy';
  document.getElementById('tabsBar').innerHTML = tabs.map(t => {
    const c = countForTab(t.id);
    return `<button class="tab${currentTab===t.id?' active':''}" onclick="setTab('${t.id}')">
      ${esc(t.label)}${c>0?`<span class="tab-badge">${c}</span>`:''}
    </button>`;
  }).join('');
}
function countForTab(id) { return getTabTasks(id).filter(t=>!t.completada).length; }
function setTab(id) { currentTab=id; moveSourceId=null; renderTabs(); renderCards(); }

// ‚îÄ‚îÄ‚îÄ DATA HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getTabTasks(tab) {
  if (tab==='hoy')   return tasks.filter(t=>t.enHoy);
  if (tab==='todas') return [...tasks];
  return tasks.filter(t=>t.ambito===tab);
}
function getSortedTasks(list) {
  const sort = document.getElementById('sortSelect')?.value || 'orden';
  const arr = [...list];
  if (sort==='orden')     arr.sort((a,b)=>(a.orden||0)-(b.orden||0));
  else if (sort==='prioridad') arr.sort((a,b)=>PRIO_ORDER[a.prioridad]-PRIO_ORDER[b.prioridad]);
  else if (sort==='deadline')  arr.sort((a,b)=>{ if(!a.deadline&&!b.deadline)return 0; if(!a.deadline)return 1; if(!b.deadline)return -1; return new Date(a.deadline)-new Date(b.deadline); });
  else if (sort==='avance') arr.sort((a,b)=>a.avance-b.avance);
  else if (sort==='ambito') { const o={}; ambitos.forEach((a,i)=>o[a.id]=i); arr.sort((a,b)=>(o[a.ambito]||99)-(o[b.ambito]||99)); }
  return arr;
}

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCards() {
  renderTabs();
  const container = document.getElementById('cardsContainer');
  const tabTasks = getTabTasks(currentTab);
  const sorted = getSortedTasks(tabTasks);

  const staticTitles = { hoy:'Hoy', todas:'Todas las tareas' };
  const amb = getAmbito(currentTab);
  document.getElementById('viewTitle').textContent = staticTitles[currentTab] || (amb.emoji+' '+amb.nombre);
  const pending = tabTasks.filter(t=>!t.completada).length;
  const total = tabTasks.length;
  document.getElementById('viewSubtitle').textContent = total ? `${pending} pendiente${pending!==1?'s':''} de ${total}` : '';
  document.getElementById('moveModeHint').classList.toggle('visible', !!moveSourceId);

  if (!sorted.length) {
    const msgs = {
      hoy:`<div class="today-hint">A√∫n no agregas tareas para hoy.<br>Abre cualquier tarea y activa "Agregar a la lista de hoy".</div>`,
      todas:`<div class="empty-state"><div class="empty-icon">‚ú¶</div><div class="empty-title">Sin tareas</div><div class="empty-sub">Toca + para crear la primera.</div></div>`
    };
    container.innerHTML = msgs[currentTab] || `<div class="empty-state"><div class="empty-icon">‚ú¶</div><div class="empty-title">Sin tareas en este √°mbito</div></div>`;
    return;
  }
  let html = '';
  sorted.forEach((task,idx) => { html += dropZone(idx, task.id); html += cardHTML(task); });
  html += dropZone(sorted.length, null);
  container.innerHTML = html;
}

function dropZone(idx, beforeId) {
  return `<div class="drop-zone" data-before="${beforeId||''}" onclick="handleDropZone(this)"></div>`;
}

function cardHTML(task) {
  const isMoving = moveSourceId === task.id;
  const amb = getAmbito(task.ambito);
  let deadlineTag = '';
  if (task.deadline) {
    const dl = new Date(task.deadline);
    const v = dl < new Date() && !task.completada;
    const fmt = dl.toLocaleDateString('es-CL',{day:'2-digit',month:'short'})+' '+dl.toLocaleTimeString('es-CL',{hour:'2-digit',minute:'2-digit'});
    deadlineTag = `<span class="tag tag-deadline${v?' vencida':''}">‚è∞ ${fmt}</span>`;
  }
  const totalHs = (task.timeLogs||[]).reduce((s,e)=>s+(e.horas||0),0);
  const estHs = task.tiempoEstimado;
  let hoursInfo = '';
  if (totalHs>0) { hoursInfo=`${totalHs.toFixed(1)} hrs trabajadas`; if(estHs) hoursInfo+=` / ${estHs} hrs est. (${Math.round(totalHs/estHs*100)}%)`; }
  else if (estHs) { hoursInfo=`Est: ${estHs} hrs`; }
  const av = task.avance||0;
  const pClass = av===100?'p100':av>=60?'phigh':av>=30?'pmid':'plow';
  const tipoMap = { hacer:'‚ñ∂ Hacer', esperar:'‚è∏ Esperar', delegar:'‚Üó Delegar', revisar:'üëÅ Revisar' };
  const hoyBtn = task.enHoy
    ? `<button class="card-btn btn-hoy-remove" onclick="toggleHoy('${task.id}',event)">‚òÄ Hoy ‚úï</button>`
    : `<button class="card-btn" onclick="toggleHoy('${task.id}',event)">‚òÄ Hoy</button>`;
  const ambitoTag = `<span class="tag" style="background:${amb.bg};color:${amb.label}">${amb.emoji} ${amb.nombre}</span>`;
  return `<div class="card-wrap${isMoving?' moving-source':''}" data-id="${task.id}">
  <div class="task-card${task.completada?' completada':''}${isMoving?' move-selected':''}" style="--stripe-color:${amb.stripe}">
    <div class="card-top">
      <button class="card-check" onclick="toggleComplete('${task.id}',event)"><span class="card-check-icon">‚úì</span></button>
      <div class="card-main">
        <div class="card-title">${esc(task.titulo)}</div>
        ${task.descripcion?`<div class="card-desc">${esc(task.descripcion).replace(/\n/g,'<br>')}</div>`:''}
      </div>
    </div>
    <div class="card-tags">
      ${ambitoTag}
      <span class="tag tag-prio-${task.prioridad}">${prioLabel(task.prioridad)}</span>
      ${task.tipo&&task.tipo!=='hacer'?`<span class="tag tag-tipo">${tipoMap[task.tipo]||''}</span>`:''}
      ${deadlineTag}
    </div>
    ${av>0||hoursInfo?`<div class="card-progress">
      <div class="progress-row">
        <div class="progress-bar-bg"><div class="progress-bar-fill ${pClass}" style="width:${av}%"></div></div>
        <span class="progress-label">${av}%</span>
      </div>
      ${hoursInfo?`<div class="hours-info">${hoursInfo}</div>`:''}
    </div>`:''}
    <div class="card-footer">
      <span class="card-meta">Creada ${formatDate(task.fechaCreacion)}</span>
      <div class="card-actions">
        ${hoyBtn}
        <button class="card-btn" onclick="openTaskModal('${task.id}',event)">Editar</button>
        <button class="card-btn btn-move${isMoving?' selected':''}" onclick="handleMoveClick('${task.id}',event)" title="Mover">‚áÖ</button>
      </div>
    </div>
  </div>
</div>`;
}

function esc(s) { if(!s)return''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function prioLabel(p) { return {alta:'Alta ‚Üë',media:'Media ‚Üí',baja:'Baja ‚Üì'}[p]||p; }
function formatDate(iso) { if(!iso)return''; return new Date(iso).toLocaleDateString('es-CL',{day:'2-digit',month:'short'}); }

// ‚îÄ‚îÄ‚îÄ MOVER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleMoveClick(id, e) {
  e.stopPropagation();
  if (moveSourceId===id) { moveSourceId=null; renderCards(); return; }
  if (moveSourceId&&moveSourceId!==id) { moveTaskBefore(moveSourceId,id); moveSourceId=null; return; }
  moveSourceId=id; renderCards();
  document.querySelectorAll('.drop-zone').forEach(z=>z.classList.add('highlight'));
}
function handleDropZone(el) {
  if (!moveSourceId) return;
  moveTaskBefore(moveSourceId, el.dataset.before||null);
  moveSourceId=null;
}
function moveTaskBefore(srcId, beforeId) {
  const list = getSortedTasks(getTabTasks(currentTab));
  const si = list.findIndex(t=>t.id===srcId);
  if (si===-1) return;
  const src = list.splice(si,1)[0];
  if (!beforeId) list.push(src);
  else { const ti=list.findIndex(t=>t.id===beforeId); list.splice(ti===-1?list.length:ti,0,src); }
  list.forEach((t,i)=>{ const r=tasks.find(x=>x.id===t.id); if(r) r.orden=i*10; });
  save(); renderCards();
}

// ‚îÄ‚îÄ‚îÄ ACCIONES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleComplete(id, e) {
  e.stopPropagation();
  const t=tasks.find(x=>x.id===id); if(!t)return;
  t.completada=!t.completada;
  if(t.completada) t.avance=100;
  save(); renderCards();
}
function toggleHoy(id, e) {
  e.stopPropagation();
  const t=tasks.find(x=>x.id===id); if(!t)return;
  t.enHoy=!t.enHoy;
  save(); renderCards();
}

// ‚îÄ‚îÄ‚îÄ √ÅMBITO SELECT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function populateAmbitoSelect(selectedId) {
  document.getElementById('fAmbito').innerHTML = ambitos.map(a=>
    `<option value="${a.id}"${a.id===selectedId?' selected':''}>${a.emoji} ${a.nombre}</option>`
  ).join('');
}

// ‚îÄ‚îÄ‚îÄ TASK MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openTaskModal(id, e) {
  if(e) e.stopPropagation();
  editingId = id||null;
  tempTimeLogs = [];
  const t = id ? tasks.find(x=>x.id===id) : null;
  document.getElementById('modalTitleText').textContent = t ? 'Editar tarea' : 'Nueva tarea';
  document.getElementById('btnDelete').style.display = t ? 'block' : 'none';
  const defaultAmbito = (currentTab!=='hoy'&&currentTab!=='todas'&&ambitos.find(a=>a.id===currentTab))
    ? currentTab : (ambitos[0]?.id||'');
  if (t) {
    document.getElementById('fTitulo').value = t.titulo||'';
    document.getElementById('fDesc').value = t.descripcion||'';
    populateAmbitoSelect(t.ambito||defaultAmbito);
    document.getElementById('fTipo').value = t.tipo||'hacer';
    document.getElementById('fPrioridad').value = t.prioridad||'media';
    document.getElementById('fTiempoEst').value = t.tiempoEstimado||'';
    document.getElementById('fDeadline').value = t.deadline ? isoToLocal(t.deadline) : '';
    document.getElementById('fAvance').value = t.avance||0;
    document.getElementById('fAvanceVal').textContent = (t.avance||0)+'%';
    document.getElementById('fEnHoy').checked = !!t.enHoy;
    tempTimeLogs = JSON.parse(JSON.stringify(t.timeLogs||[]));
  } else {
    document.getElementById('fTitulo').value='';
    document.getElementById('fDesc').value='';
    populateAmbitoSelect(defaultAmbito);
    document.getElementById('fTipo').value='hacer';
    document.getElementById('fPrioridad').value='media';
    document.getElementById('fTiempoEst').value='';
    document.getElementById('fDeadline').value='';
    document.getElementById('fAvance').value=0;
    document.getElementById('fAvanceVal').textContent='0%';
    document.getElementById('fEnHoy').checked = currentTab==='hoy';
    tempTimeLogs=[];
  }
  document.getElementById('tlHoras').value='';
  document.getElementById('tlNota').value='';
  renderTimeLogModal();
  document.getElementById('taskModal').classList.add('open');
  setTimeout(()=>document.getElementById('fTitulo').focus(),200);
}
function closeTaskModal() { document.getElementById('taskModal').classList.remove('open'); editingId=null; }
function isoToLocal(iso) {
  const d=new Date(iso); const p=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
}
function saveTask() {
  const titulo = document.getElementById('fTitulo').value.trim();
  if (!titulo) { document.getElementById('fTitulo').focus(); return; }
  const deadlineRaw = document.getElementById('fDeadline').value;
  if (editingId) {
    const t=tasks.find(x=>x.id===editingId);
    if(t){
      t.titulo=titulo; t.descripcion=document.getElementById('fDesc').value.trim();
      t.ambito=document.getElementById('fAmbito').value; t.tipo=document.getElementById('fTipo').value;
      t.prioridad=document.getElementById('fPrioridad').value;
      t.tiempoEstimado=parseFloat(document.getElementById('fTiempoEst').value)||null;
      t.deadline=deadlineRaw?new Date(deadlineRaw).toISOString():null;
      t.avance=parseInt(document.getElementById('fAvance').value);
      t.enHoy=document.getElementById('fEnHoy').checked;
      t.timeLogs=[...tempTimeLogs];
      if(t.avance===100) t.completada=true;
    }
  } else {
    const maxO = tasks.length ? Math.max(...tasks.map(t=>t.orden||0)) : -10;
    tasks.push({
      id:uid(), titulo, descripcion:document.getElementById('fDesc').value.trim(),
      ambito:document.getElementById('fAmbito').value, tipo:document.getElementById('fTipo').value,
      prioridad:document.getElementById('fPrioridad').value,
      tiempoEstimado:parseFloat(document.getElementById('fTiempoEst').value)||null,
      deadline:deadlineRaw?new Date(deadlineRaw).toISOString():null,
      avance:parseInt(document.getElementById('fAvance').value),
      enHoy:document.getElementById('fEnHoy').checked,
      completada:false, timeLogs:[...tempTimeLogs],
      fechaCreacion:new Date().toISOString(), orden:maxO+10,
    });
  }
  save(); closeTaskModal(); renderCards();
}
function deleteTask() {
  if (!editingId) return;
  if (!confirm('¬øEliminar esta tarea?')) return;
  tasks=tasks.filter(t=>t.id!==editingId);
  save(); closeTaskModal(); renderCards();
}

// ‚îÄ‚îÄ‚îÄ TIME LOG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTimeLogModal() {
  const list=document.getElementById('timelogList');
  if (!tempTimeLogs.length) { list.style.display='none'; return; }
  list.style.display='block';
  list.innerHTML=tempTimeLogs.map((e,i)=>`
    <div class="timelog-entry">
      <span class="timelog-date">${new Date(e.fecha).toLocaleDateString('es-CL',{day:'2-digit',month:'short',year:'2-digit'})}</span>
      <span class="timelog-hours">${e.horas} hrs</span>
      <span class="timelog-nota">${esc(e.nota||'')}</span>
      <button class="timelog-del" onclick="removeTimeLog(${i})">√ó</button>
    </div>`).join('');
}
function addTimeLog() {
  const h=parseFloat(document.getElementById('tlHoras').value);
  if(!h||h<=0){document.getElementById('tlHoras').focus();return;}
  tempTimeLogs.push({fecha:new Date().toISOString(),horas:h,nota:document.getElementById('tlNota').value.trim()});
  document.getElementById('tlHoras').value=''; document.getElementById('tlNota').value='';
  renderTimeLogModal();
}
function removeTimeLog(idx){tempTimeLogs.splice(idx,1);renderTimeLogModal();}

// ‚îÄ‚îÄ‚îÄ √ÅMBITOS MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openAmbitosModal() {
  renderAmbitosList();
  document.getElementById('newAmbitoNombre').value='';
  document.getElementById('newAmbitoEmoji').value='';
  document.getElementById('ambitosModal').classList.add('open');
}
function closeAmbitosModal() { document.getElementById('ambitosModal').classList.remove('open'); renderCards(); }
function renderAmbitosList() {
  document.getElementById('ambitosList').innerHTML = ambitos.map(a=>{
    const c=tasks.filter(t=>t.ambito===a.id).length;
    return `<div class="ambito-row">
      <div class="ambito-swatch" style="background:${a.bg};border-color:${a.stripe}"></div>
      <span class="ambito-row-emoji">${a.emoji}</span>
      <span class="ambito-row-name">${esc(a.nombre)}</span>
      <span class="ambito-row-count">${c} tarea${c!==1?'s':''}</span>
      <button class="btn-ambito-del" onclick="deleteAmbito('${a.id}')" ${c===0?'':'disabled'}
        title="${c===0?'Eliminar':'No se puede eliminar: tiene tareas asignadas'}">Eliminar</button>
    </div>`;
  }).join('');
}
function addAmbito() {
  const nombre=document.getElementById('newAmbitoNombre').value.trim();
  if(!nombre){document.getElementById('newAmbitoNombre').focus();return;}
  const emoji=document.getElementById('newAmbitoEmoji').value.trim()||'üìå';
  const stripeHex=document.getElementById('newAmbitoColor').value;
  const bg=lightenHex(stripeHex,0.6);
  const label=darkenHex(stripeHex,0.4);
  const id=nombre.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'').slice(0,28)+'_'+Date.now().toString(36).slice(-4);
  ambitos.push({id,nombre,emoji,bg,stripe:stripeHex,label});
  save();
  document.getElementById('newAmbitoNombre').value='';
  document.getElementById('newAmbitoEmoji').value='';
  renderAmbitosList();
}
function deleteAmbito(id) {
  if(tasks.filter(t=>t.ambito===id).length>0){alert('No puedes eliminar un √°mbito que tiene tareas asignadas.');return;}
  if(!confirm('¬øEliminar este √°mbito?'))return;
  ambitos=ambitos.filter(a=>a.id!==id);
  if(currentTab===id) currentTab='hoy';
  save(); renderAmbitosList();
}

// Color helpers
function hexToRgb(hex){const h=hex.replace('#','');return[parseInt(h.slice(0,2),16),parseInt(h.slice(2,4),16),parseInt(h.slice(4,6),16)];}
function lightenHex(hex,amt){const[r,g,b]=hexToRgb(hex);const m=c=>Math.round(c+(255-c)*amt);return`rgb(${m(r)},${m(g)},${m(b)})`;}
function darkenHex(hex,amt){const[r,g,b]=hexToRgb(hex);const m=c=>Math.round(c*(1-amt));return`rgb(${m(r)},${m(g)},${m(b)})`;}

// ‚îÄ‚îÄ‚îÄ GIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openGistModal(){const g=loadGistCfg();document.getElementById('gToken').value=g.token||'';document.getElementById('gGistId').value=g.gistId||'';document.getElementById('gistStatus').innerHTML='';document.getElementById('gistModal').classList.add('open');}
function closeGistModal(){document.getElementById('gistModal').classList.remove('open');}
function loadGistCfg(){try{return JSON.parse(localStorage.getItem('tareas_gist')||'{}')}catch(e){return {};}}
function saveGistCfg(t,g){localStorage.setItem('tareas_gist',JSON.stringify({token:t,gistId:g}));}
function setGistStatus(m,t){document.getElementById('gistStatus').innerHTML=`<div class="gist-status ${t}">${m}</div>`;}

async function gistSave(){
  const token=document.getElementById('gToken').value.trim();
  const gistId=document.getElementById('gGistId').value.trim();
  if(!token){setGistStatus('Necesitas ingresar tu token.','err');return;}
  setGistStatus('Guardando...','info');
  const body={description:'Tareas App Data',public:false,files:{'tareas.json':{content:JSON.stringify({tasks,ambitos},null,2)}}};
  try{
    let url='https://api.github.com/gists',method='POST';
    if(gistId){url+='/'+gistId;method='PATCH';}
    const res=await fetch(url,{method,headers:{Authorization:'token '+token,'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!res.ok)throw new Error(res.statusText);
    const json=await res.json();
    document.getElementById('gGistId').value=json.id;
    saveGistCfg(token,json.id);
    setGistStatus(`‚úì Guardado. Gist ID: <strong>${json.id}</strong>`,'ok');
  }catch(e){setGistStatus('Error: '+e.message,'err');}
}
async function gistLoad(){
  const token=document.getElementById('gToken').value.trim();
  const gistId=document.getElementById('gGistId').value.trim();
  if(!token||!gistId){setGistStatus('Necesitas token y Gist ID para cargar.','err');return;}
  setGistStatus('Cargando...','info');
  try{
    const res=await fetch(`https://api.github.com/gists/${gistId}`,{headers:{Authorization:'token '+token}});
    if(!res.ok)throw new Error(res.statusText);
    const json=await res.json();
    const content=json.files['tareas.json']?.content;
    if(!content)throw new Error('No se encontr√≥ tareas.json en el gist.');
    const loaded=JSON.parse(content);
    if(Array.isArray(loaded)){tasks=loaded;}
    else{tasks=loaded.tasks||[];if(Array.isArray(loaded.ambitos)&&loaded.ambitos.length)ambitos=loaded.ambitos;}
    saveGistCfg(token,gistId);save();
    setGistStatus(`‚úì ${tasks.length} tarea${tasks.length!==1?'s':''} cargada${tasks.length!==1?'s':''}.`,'ok');
    renderCards();
  }catch(e){setGistStatus('Error: '+e.message,'err');}
}

function exportJSON(){
  const b=new Blob([JSON.stringify({tasks,ambitos},null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);
  a.download='tareas_'+new Date().toISOString().slice(0,10)+'.json';a.click();
}

// ‚îÄ‚îÄ‚îÄ CERRAR MODALES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
['taskModal','gistModal','ambitosModal'].forEach(id=>{
  document.getElementById(id).addEventListener('click',e=>{
    if(e.target===document.getElementById(id)){
      if(id==='taskModal')closeTaskModal();
      else if(id==='gistModal')closeGistModal();
      else closeAmbitosModal();
    }
  });
});

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
load();
renderCards();
</script>
</body>
</html>
